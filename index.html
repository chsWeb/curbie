<!doctype html>
<html>
<head>
<meta charset="UTF-8" />
<title>Curbie – Recycling Pickup Reminder</title>

<style>
body { font-family: system-ui, -apple-system, Segoe UI; margin: 32px; line-height: 1.5; }
label { display:block; margin-top: 14px; }
h1 { margin-bottom: 0.35em; }
.output { margin-top: 20px; font-size: 1.25rem; font-weight: 600; }
form { margin-top: 28px; padding: 14px; border: 1px solid #ddd; border-radius: 10px; max-width: 420px; }
button { margin-top: 12px; padding: 8px 14px; border-radius: 8px; border: 0; cursor:pointer; }
small { color:#666; }
</style>
</head>

<body>

<h1>Curbie</h1>
<p>Find your next recycling pickup and get reminders.</p>

<label>
  Collection Week
  <select id="week">
    <option value="1">Collection Week 1</option>
    <option value="2">Collection Week 2</option>
  </select>
</label>

<label>
  Pickup Day
  <select id="day">
    <option value="1">Monday</option>
    <option value="2">Tuesday</option>
    <option value="3">Wednesday</option>
    <option value="4">Thursday</option>
    <option value="5">Friday</option>
  </select>
</label>

<label>
  Route Color
  <select id="color">
    <option value="blue">Blue</option>
    <option value="green">Green</option>
    <option value="purple">Purple</option>
    <option value="yellow">Yellow</option>
    <option value="orange">Orange</option>
    <option value="red">Red</option>
  </select>
</label>

<div class="output" id="result"></div>

<hr style="margin:30px 0" />

<h3>Get reminders</h3>

<form action="https://formspree.io/f/mjgkklyq" method="POST">
  <label>
    Email
    <input type="email" name="email" required>
  </label>

  <input type="hidden" name="source" value="Curbie">

  <label>
    Message (optional)
    <textarea name="message" placeholder="Tell us your color and collection week if you want."></textarea>
  </label>

  <button type="submit">Notify Me</button>
  <small>We’ll only email reminders about recycling pickup.</small>
</form>

<script>
// --------------------------------------
// CONFIG
// --------------------------------------
const YEAR = 2026;

// IMPORTANT: build dates in *local* time (no timezone shift)
const FIRST_WEEK1_MONDAY = new Date(YEAR, 0, 5); // Jan 5, 2026

function addDays(date, days) {
  const d = new Date(date);
  d.setDate(d.getDate() + days);
  return d;
}

function generateDates(collectionWeek, weekdayIndex) {
  const startOffset = (collectionWeek === 1 ? 0 : 7) + (weekdayIndex - 1);
  let date = addDays(FIRST_WEEK1_MONDAY, startOffset);

  const dates = [];
  while (date.getFullYear() === YEAR) {
    dates.push(new Date(date));
    date = addDays(date, 14);
  }
  return dates;
}

function nextPickup(dates) {
  const today = new Date();
  today.setHours(0,0,0,0);
  for (const d of dates) {
    if (d >= today) return d.toDateString();
  }
  return "No more pickups scheduled this year.";
}

function savePreferencesToOneSignal(week, day, color) {
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.User.addTag("week", week);
    await OneSignal.User.addTag("day", day);
    await OneSignal.User.addTag("color", color);
  });

  localStorage.setItem("curbiePrefs", JSON.stringify({ week, day, color }));
}

function update() {
  const week = Number(document.getElementById("week").value);
  const day = Number(document.getElementById("day").value);
  const color = document.getElementById("color").value;

  const dates = generateDates(week, day);
  document.getElementById("result").textContent =
    `Your next pickup is: ${nextPickup(dates)}`;

  savePreferencesToOneSignal(week, day, color);
}

// Restore saved values on load
const saved = localStorage.getItem("curbiePrefs");
if (saved) {
  const prefs = JSON.parse(saved);
  document.getElementById("week").value = prefs.week;
  document.getElementById("day").value = prefs.day;
  document.getElementById("color").value = prefs.color;
}

document.querySelectorAll("select").forEach(s =>
  s.addEventListener("change", update)
);

update();
</script>

<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "58063cbf-6eb3-49d1-badf-0d9c99548fe9",
      safari_web_id: "web.onesignal.auto.5dcf04a7-d9b5-4793-8717-b5ec1870e3bb",
      notifyButton: { enable: true }
    });
  });
</script>

</body>
</html>
